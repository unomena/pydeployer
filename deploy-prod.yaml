name: pydeployer
environment: production
python_version: "3.11"  # Will use available version if 3.11 not found
requirements: requirements.txt

services:
  - name: web
    type: django
    command: gunicorn --bind 127.0.0.1:${PORT} --workers=2 --threads=4 --worker-class=gthread pydeployer.wsgi
    enabled: true
    health_check:
      endpoint: /api/status/
      interval: 60
    resources:
      max_memory: 1024
      max_cpu: 0.5

env_vars:
  DJANGO_SETTINGS_MODULE: pydeployer.settings
  PYTHONUNBUFFERED: "1"
  DEBUG: "0"
  ALLOWED_HOSTS: "*"
  DATABASE_URL: "postgresql://deployer:deployer_pass_2024@localhost/pydeployer"
  REDIS_URL: "redis://localhost:6379/0"
  SECRET_KEY: "django-insecure-prod-key-please-change-in-production"
  DEPLOYMENT_ROOT: "/srv/deployments"
  DEPLOYMENT_USER: deploy
  ENCRYPTION_KEY: "will-be-loaded-from-env-file"

hooks:
  pre_deploy:
    - cd src && python manage.py migrate --noinput
    - cd src && python manage.py collectstatic --noinput
    - cd src && python manage.py check --deploy
  post_deploy:
    - cd src && python manage.py check