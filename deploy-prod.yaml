name: pydeployer
environment: production
python_version: "3.11"
requirements: requirements.txt

services:
  - name: web
    type: django
    command: gunicorn --bind 127.0.0.1:${PORT} --workers=2 --threads=4 --worker-class=gthread pydeployer.wsgi
    enabled: true
    health_check:
      endpoint: /api/status/
      interval: 60
    resources:
      max_memory: 1024
      max_cpu: 0.5

env_vars:
  DJANGO_SETTINGS_MODULE: pydeployer.settings
  PYTHONUNBUFFERED: "1"
  DEBUG: "0"
  ALLOWED_HOSTS: "deploy.company.com,localhost"
  DATABASE_URL: ${SECRET_DATABASE_URL}
  REDIS_URL: ${SECRET_REDIS_URL}
  SECRET_KEY: ${SECRET_DJANGO_SECRET_KEY}
  DEPLOYMENT_ROOT: /opt/deployments
  DEPLOYMENT_USER: deploy

hooks:
  pre_deploy:
    - cd src && python manage.py migrate --noinput
    - cd src && python manage.py collectstatic --noinput
    - cd src && python manage.py check --deploy
  post_deploy:
    - cd src && python manage.py check